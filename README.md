# 連結性制約を考慮したナップザック問題

$n \times n$ の碁盤状グリッド上で、$m$ 人のプレイヤーがそれぞれセルを占有し、スコアを獲得しながら各自の領域を**連結**に保つことを目指す組み合わせ最適化問題。

---

## 問題設定

| 記号 | 説明 |
|------|------|
| $n$ | グリッドの一辺のサイズ |
| $m$ | プレイヤー数 |
| $g_{ij}$ | セル $(i,j)$ のスコア値 |
| $R_k$ | プレイヤー $k$ の最低得点要求 |

### 決定変数

$$
x_{ijk} =
\begin{cases}
1, & \text{プレイヤー } k \text{ がセル } (i,j) \text{ を占有する,}\\
0, & \text{それ以外.}
\end{cases}
$$

### 制約条件

1. **各セルに高々1つの石**

$$
\sum_{k=1}^m x_{ijk} \le 1 \quad \forall i,j
$$

2. **各プレイヤーの最低得点要求**

$$
\sum_{i,j} g_{ij}\, x_{ijk} \ge R_k \quad \forall k
$$

3. **各プレイヤーの占有領域は連結**（ヒューリスティックに近似）

---

## アルゴリズム

完全な連結性制約をフロー制約で表現すると計算量が爆発するため、**ヒューリスティック局所探索**を用いる。

### 損失関数（複合目的関数）

$$
\mathcal{L} = \underbrace{\text{edge-diff}}_{\text{連結性の近似}} + \lambda \underbrace{\sum_{k=1}^m \max\left(0, R_k - \mathrm{score}_k\right)}_{\text{要求未達ペナルティ}}
$$

- **edge\_diff**：異なるプレイヤーが隣接するセルペアの総数。これを小さくすることで各プレイヤーの領域がコンパクト・連結に近づく。
- **要求未達ペナルティ**：得点要求 $R_k$ を下回ったプレイヤーの不足量の総和。$\lambda$ で重みを調整。
- $\lambda = 0$ にすると連結性のみ最適化（要求制約を無視）し、$\lambda$ を大きくするほど要求制約を厳しく扱う。

### フェーズ1 — 貪欲初期割り当て

スコアが高いセルから順に、**残りスコア枠（上限 $1.2 R_k$ - 現スコア）が最も狭いプレイヤー**へ割り当てる。全プレイヤーが要求を満たした時点で停止。

### フェーズ2 — 局所探索

各イテレーションで以下をランダムに試行し、$\Delta\mathcal{L} < 0$ の場合のみ採用：

- **スワップ**：ランダムな2セルの割り当てを入れ替える
- **再割り当て**：ランダムな1セルの割り当てを別のプレイヤー（または空）に変更

$\Delta\mathcal{L}$ の計算は影響を受けるプレイヤー分のみ行うため、各ステップは $O(1)$。

---

## 実装

TypeScript + Vite による Web アプリ。計算は **Web Worker** でバックグラウンド実行するためメインスレッドをブロックしない。

```
src/
├── solver.ts          # 最適化アルゴリズム本体（PRNG・初期割り当て・局所探索）
├── solver.worker.ts   # Web Worker エントリポイント（最適化ループ）
├── main.ts            # UI ロジック・Canvas 描画・損失グラフ
└── i18n.ts            # 日本語 / English 切り替え
```

---

## 環境構築・実行方法

Node.js v18 以上が必要。

```bash
npm install
npm run dev
```

ブラウザで `http://localhost:5173` を開くとインタラクティブなソルバーが起動する。

### ビルド（本番用）

```bash
npm run build
```

`dist/` に静的ファイルが生成される。

---

## パラメータ一覧

| パラメータ | 説明 | デフォルト |
|-----------|------|----------|
| グリッドサイズ $n$ | $n \times n$ グリッド（5–20） | 12 |
| プレイヤー数 $m$ | 2–15 | 12 |
| セルスコア範囲 | 各セルの値の乱数範囲 | 10–20 |
| 要求スコア範囲 | 各 $R_k$ の乱数範囲 | 150–200 |
| 乱数シード | 再現性のための固定シード | 4 |
| 最大イテレーション数 | 局所探索の反復回数（1,000–500,000） | 100,000 |
| 要求ペナルティ $\lambda$ | 要求制約の重み（0 = 無視） | 1 |
